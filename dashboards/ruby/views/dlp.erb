<div class="page-header">
  <h1>Data Loss Prevention</h1>
  <p>Manage DLP rules and review violations</p>
</div>

<div class="card">
  <h3>Create DLP Rule</h3>
  <form method="post" action="/dlp/rules/create">
    <div class="form-row">
      <div class="form-group">
        <label>Name</label>
        <input type="text" name="name" required placeholder="e.g. Credit Card Detection">
      </div>
      <div class="form-group">
        <label>Action</label>
        <input type="text" name="action" placeholder="e.g. block" value="block">
      </div>
    </div>
    <div class="form-group">
      <label>Pattern</label>
      <input type="text" name="pattern" required placeholder="e.g. \b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b">
    </div>
    <button class="btn btn-primary" type="submit">Create Rule</button>
  </form>
</div>

<div class="card">
  <h3>DLP Rules (<%= @rules.size %>)</h3>
  <% if @rules.empty? %>
    <div class="empty"><span class="icon">&#128274;</span>No DLP rules configured. Create one above.</div>
  <% else %>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Name</th><th>Pattern</th><th>Action</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody>
          <% @rules.each do |r| %>
            <tr>
              <td><strong><%= escape_html(r['name'] || '-') %></strong></td>
              <td><code><%= escape_html(r['pattern'] || '-') %></code></td>
              <td><%= escape_html(r['action'] || '-') %></td>
              <td><%= status_badge(r['status'] || 'enabled') %></td>
              <td>
                <form method="post" action="/dlp/rules/<%= r['id'] %>/delete" style="display:inline" onsubmit="return confirm('Delete this DLP rule?')">
                  <button class="btn btn-sm btn-danger" type="submit">Delete</button>
                </form>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% end %>
</div>

<div class="card">
  <h3>Test Scan</h3>
  <form method="post" action="/dlp/scan">
    <div class="form-group">
      <label>Content to Scan</label>
      <textarea name="content" rows="4" required placeholder="Paste content to test against DLP rules..."></textarea>
    </div>
    <button class="btn btn-primary" type="submit">Run Scan</button>
  </form>
</div>

<div class="card">
  <h3>Violations (<%= @violations.size %>)</h3>
  <% if @violations.empty? %>
    <div class="empty"><span class="icon">&#9989;</span>No DLP violations detected</div>
  <% else %>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Rule</th><th>Content</th><th>Severity</th><th>Agent</th><th>Time</th></tr></thead>
        <tbody>
          <% @violations.each do |v| %>
            <tr>
              <td><strong><%= escape_html(v['rule_name'] || v['rule'] || '-') %></strong></td>
              <td><code><%= escape_html(v['content'] || v['match'] || '-') %></code></td>
              <td><%= status_badge(v['severity'] || 'medium') %></td>
              <td><%= escape_html(v['agent'] || v['agent_id'] || '-') %></td>
              <td style="color:var(--text-muted)"><%= time_ago(v['created_at'] || v['timestamp']) %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% end %>
</div>
